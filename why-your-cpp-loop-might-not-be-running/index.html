<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/" rel="canonical" />
  <!-- Feed -->
  <link href="https://azad2171.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
    title="Between the Brackets Full Atom Feed" />
  <link href="https://azad2171.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate"
    title="Between the Brackets Full RSS Feed" />
  <link href="https://azad2171.github.io/feeds/programming.atom.xml" type="application/atom+xml"
    rel="alternate" title="Between the Brackets Categories Atom Feed" />
  <link href="https://azad2171.github.io/feeds/programming.rss.xml" type="application/rss+xml"
    rel="alternate" title="Between the Brackets Categories RSS Feed" />

  <link rel="stylesheet" type="text/css" href="https://azad2171.github.io/theme/css/style.css">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <script>
    var siteUrl = 'https://azad2171.github.io';
  </script>

  <script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>







    <meta name="description" content="Learn how the volatile keyword and compiler optimizations affect control flow in low-latency C++ code.">

    <meta name="author" content="Lovekesh Azad">

    <meta name="tags" content="C++">
    <meta name="tags" content="VOLATILE">
    <meta name="tags" content="Low Latency Programming">




<!-- Open Graph -->
<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="Between the Brackets"/>
<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations"/>
<meta prefix="og: http://ogp.me/ns#" property="og:description" content="Learn how the volatile keyword and compiler optimizations affect control flow in low-latency C++ code."/>
<meta prefix="og: http://ogp.me/ns#" property="og:locale" content="en_US"/>
<meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/"/>
<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"/>
<meta prefix="og: http://ogp.me/ns#" property="article:published_time" content="2025-07-20 22:00:00+05:30"/>
<meta prefix="og: http://ogp.me/ns#" property="article:modified_time" content=""/>
<meta prefix="og: http://ogp.me/ns#" property="article:author" content="https://azad2171.github.io/author/lovekesh-azad.html">
<meta prefix="og: http://ogp.me/ns#" property="article:section" content="Programming"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="C++"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="VOLATILE"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="Low Latency Programming"/>
<meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://azad2171.github.io/theme/images/home-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations",
  "headline": "Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations",
  "datePublished": "2025-07-20 22:00:00+05:30",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Lovekesh Azad",
    "url": "https://azad2171.github.io/author/lovekesh-azad.html"
  },
  "image": "https://azad2171.github.io/theme/images/post-bg.jpg",
  "url": "https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/",
  "description": "Learn how the volatile keyword and compiler optimizations affect control flow in low-latency C++ code."
}
</script>
</head>









<body class="category-template">

<div class="nav-header">
  <nav class="nav-wrapper" aria-label="Main">
<ul>

    <li class="nav-Home " role="presentation"><a href="/"><span>Home</span></a></li>
    <li class="nav-About the Author " role="presentation"><a href="/author/lovekesh-azad.html"><span>About the Author</span></a></li>

</ul>
<ul class="nav-meta">
  <li class="nav-search" style="display: none;">
    <a title="Search">
      <i class="icon icon-search" aria-hidden="true"></i>
      <span>Search</span>
    </a>
  </li>
</ul>  </nav>

  <div class="nav-wrapper-control">
    <div class="inner">
      <a class="nav-menu" role="button"><i class="icon icon-menu" aria-hidden="true"></i>Menu</a>
      <a class="nav-search" title="Search" role="button" style="display: none;"><i class="icon icon-search" aria-hidden="true"></i></a>
    </div>
  </div>
</div>
<div class="nav-close" role="button" aria-label="Close"></div>
  <section id="wrapper" class="page-wrapper">
    <!-- Progressbar -->
    <div class="progress-container">
      <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header class="post-header ">
      <div class="inner">
        <span class="post-info">
          <span class="post-type">Article</span>
          <span class="post-count">Programming</span>
        </span>
        <h1 class="post-title">Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations</h1>
        <div class="post-meta">
          <div class="post-meta-avatars">


            <figure class="post-meta-avatar avatar">
              <a class="author-avatar" href="https://azad2171.github.io/author/lovekesh-azad.html">
                <img class="author-profile-image" src="https://azad2171.github.io/authors/avatar.png" alt="Lovekesh Azad" />
              </a>
            </figure>
          </div>

          <h4 class="post-meta-author">
            Lovekesh Azad
          </h4>
          <time datetime="Sun 20 July 2025">Sun 20 July 2025</time>
        </div>
      </div>
    </header>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
          <section class="post-content">
            <h1>Understanding the <code>volatile</code> Keyword and Compiler Optimizations</h1>
<p>In C++, writing a loop that counts from 1 to a billion feels like a sure way to consume time and CPU cycles. But what if your loop - even with all its iterations - <strong>doesn’t run at all</strong>? Or what if your carefully written benchmark gets replaced by a single line of code?</p>
<p>Welcome to the world of <strong>modern compiler optimizations</strong>, where the compiler often knows better than you - and isn't afraid to prove it.</p>
<p>This article introduces a critical concept in C++: the <code>volatile</code> keyword, and why your code may not behave the way you think it will - especially when performance is involved.</p>
<hr>
<h2>The Problem: A Loop That “Should” Take Time</h2>
<p>Let’s take a look at this innocent-looking C++ code:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1&#39;000&#39;000&#39;000</span><span class="p">;</span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">iterations</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sink</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">nanoseconds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Result: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sink</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Time: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">nanoseconds</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; nanoseconds&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This code should, at a glance, take a few hundred milliseconds, maybe even a second, to run a <strong>billion</strong> additions.</p>
<p>And yet, when compiled in <strong>Release mode</strong>, you might see output like this:</p>
<div class="highlight"><pre><span></span><code><span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="mi">1000000000</span><span class="w">  </span>
<span class="n">Time</span><span class="o">:</span><span class="w"> </span><span class="mi">150</span><span class="w"> </span><span class="n">nanoseconds</span>
</code></pre></div>

<p>Wait - what?</p>
<hr>
<h2>What Happened: The Compiler Outsmarted You</h2>
<p>The compiler looked at this loop and thought:</p>
<blockquote>
<p>“You're just adding 1 a billion times? I know how this ends.”</p>
</blockquote>
<p>And instead of generating machine code for a billion iterations, it optimized the loop into this:</p>
<div class="highlight"><pre><span></span><code><span class="n">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1&#39;000&#39;000&#39;000</span><span class="p">;</span>
</code></pre></div>

<p>No loop. No wasted CPU cycles. Just the final result, instantly.</p>
<p>The output is correct i.e. <code>sink</code> is <code>1,000,000,000</code> - but the loop never actually ran.</p>
<p>This is an example of <strong>dead code elimination</strong> and <strong>loop strength reduction</strong>, two standard optimizations in modern compilers like MSVC, Clang, and GCC.</p>
<hr>
<h2>Introducing <code>volatile</code>: Your Code’s Bodyguard</h2>
<p>To stop the compiler from doing this, we can use the <code>volatile</code> keyword:</p>
<div class="highlight"><pre><span></span><code><span class="k">volatile</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>

<p>This keyword tells the compiler:</p>
<blockquote>
<p>“Do not optimize reads or writes to this variable. Every access is important, even if it seems pointless to you.”</p>
</blockquote>
<p>With <code>volatile</code>, the compiler is forced to generate real instructions for every addition, and now the loop takes <strong>real time</strong> to run. You might see:</p>
<div class="highlight"><pre><span></span><code><span class="n">Result</span><span class="o">:</span><span class="w"> </span><span class="mi">1000000000</span><span class="w">  </span>
<span class="n">Time</span><span class="o">:</span><span class="w"> </span><span class="mi">450000000</span><span class="w"> </span><span class="n">nanoseconds</span>
</code></pre></div>

<p>That’s more like it.</p>
<hr>
<h2>What Exactly Does <code>volatile</code> Do?</h2>
<p>In C++, <code>volatile</code> is a type qualifier that instructs the compiler:</p>
<ul>
<li><strong>Do not cache this variable in a register.</strong></li>
<li><strong>Do not remove or merge reads/writes.</strong></li>
<li><strong>Assume this variable might be changed by something outside your current code.</strong></li>
</ul>
<p>It’s commonly used in embedded systems and multithreaded contexts where variables might change due to hardware or background processes.</p>
<p>In our case, it's used as a <strong>benchmarking hack</strong> - we don’t want the compiler to optimize our code away while we’re trying to measure it.</p>
<hr>
<h2>When Not to Use <code>volatile</code></h2>
<p>It’s tempting to use <code>volatile</code> everywhere once you discover it, but resist that urge.</p>
<ul>
<li>It <strong>does not make your code thread-safe</strong>.</li>
<li>It can <strong>reduce performance</strong> by disabling useful optimizations.</li>
<li>It should be reserved for <strong>rare, specific scenarios</strong> like memory-mapped hardware or precise timing measurements.</li>
</ul>
<p>Use it sparingly, and only when you truly need to prevent the compiler from reordering or eliminating reads/writes.</p>
<hr>
<h2>Key Takeaways</h2>
<ul>
<li><strong>Modern C++ compilers are extremely aggressive</strong> about optimizing your code - even to the point of deleting entire loops.</li>
<li>The keyword <code>volatile</code> tells the compiler: <em>“Hands off. Don’t optimize this.”</em></li>
<li>If you're benchmarking or dealing with low-level systems, knowing when and how to use <code>volatile</code> is essential.</li>
<li>Don't assume your code is running just because you wrote it - <strong>always measure, and always verify</strong>.</li>
</ul>
<hr>
<blockquote>
<p>“The best performance improvement is the one your compiler gives you for free - unless it gives you <em>zero</em>.”<br>
— <em>A C++ developer, watching their loop vanish into thin air</em></p>
</blockquote>
<p>If you’re new to low-level benchmarking, you might also like <a href="from-python-to-nanoseconds-understanding-c-build-modes-through-a-simple-timing-benchmark.html">this article on build modes</a>.</p>
          </section>


          <section class="post-footer" >
            <div class="post-share">
              <span class="post-info-label">Share</span>
              <a title="Twitter" aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations&amp;url=https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="icon icon-twitter" aria-hidden="true"></i><span class="hidden">Twitter</span>
              </a>
              <a title="Facebook" aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="icon icon-facebook" aria-hidden="true"></i><span class="hidden">Facebook</span>
              </a>
              <a title="LinkedIn" aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/&amp;title=Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;">
                <i class="icon icon-linkedin" aria-hidden="true"></i><span class="hidden">LinkedIn</span>
              </a>
              <a title="Email" aria-label="Email" class="email" href="mailto:?subject=Why Your C++ Loop Might Not Run: Volatile & Compiler Optimizations&amp;body=https://azad2171.github.io/why-your-cpp-loop-might-not-be-running/">
                <i class="icon icon-mail" aria-hidden="true"></i><span class="hidden">Email</span>
              </a>
              <div class="clear"></div>
            </div>

            <aside class="post-tags">
<a href="https://azad2171.github.io/tag/c.html">C++</a><a href="https://azad2171.github.io/tag/volatile.html">VOLATILE</a><a href="https://azad2171.github.io/tag/low-latency-programming.html">Low Latency Programming</a>            </aside>

            <div class="clear"></div>


          </section>


          <aside class="post-nav">
            <a class="post-nav-prev" href="https://azad2171.github.io/why-integer-math-is-faster-than-floating-point/">
              <section class="post-nav-teaser">
                <i class="icon icon-arrow-right"></i>
                  <h2 class="post-nav-title">Why Integer Math Is So Much Faster Than Floating-Point</h2>
                <p class="post-nav-excerpt">Discover why integer operations outperform floating-point math in C++ and how it...</p>
                <p class="post-nav-meta"><time datetime="Fri 18 July 2025">Fri 18 July 2025</time></p>
              </section>
            </a>
            <div class="clear"></div>
          </aside>

        </div>
      </article>
    </main>
    <div class="nav-footer">
      <nav class="nav-wrapper" aria-label="Footer">
        <span class="nav-copy">Between the Brackets &copy; 2025
        </span>
        <span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> &bull; Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> &bull;
          <a class="menu-item js-theme" href="#" data-system="System theme" data-dark="Dark theme" data-light="Light theme">
            <span class="theme-icon"></span><span class="theme-text">System theme</span>
          </a>
        </span>
      </nav>
    </div>

  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script type="text/javascript" src="https://azad2171.github.io/theme/js/jquery.fitvids.js"></script>
  <script type="text/javascript" src="https://azad2171.github.io/theme/js/script.js"></script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7Y574CSESH"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7Y574CSESH', { 'anonymize_ip': true });
    </script>

  <!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->

<!-- Add MathJax and FontAwesome for Asciidoc -->\
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    var mdSelector=".highlight pre";
    var rstSelector=".highlight pre";
    // For ":source-highlighter: highlight.js`" in asciidoc
    var adocSelector="pre.highlight > code[data-lang]"
    var selector=mdSelector;
    // Format code blocks and add line numbers
    function codestyling() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
        // No lines for plain text blocks
        if (!$(this).hasClass('language-text')) {
          var code = $(this);
          // Calculate amount of lines
          var lines = code.html().split(/\n(?!$)/g).length;
          var numbers = [];
          if (lines > 1) {
            lines++;
          }
          for (i = 1; i < lines; i++) {
            numbers += '<span class="line" aria-hidden="true">' + i + '</span>';
          }
          code.parent().append('<div class="lines">' + numbers + '</div>');
        }
      });
    }

    // Format code blocks only
    function codestylingWithoutLineNumbers() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
      });
    }

    codestylingWithoutLineNumbers();
    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>

</html>